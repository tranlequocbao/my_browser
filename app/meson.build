# ==============================================================================
# FILE: app/meson.build - C·∫§U H√åNH BUILD CHO TH∆Ø M·ª§C APP
# ==============================================================================
#
# File n√†y ƒë·ªãnh nghƒ©a:
#   1. Danh s√°ch source files c·∫ßn compile
#   2. C√°ch t·∫°o executable
#   3. Data files c·∫ßn install
#
# ==============================================================================

# ------------------------------------------------------------------------------
# DANH S√ÅCH SOURCE FILES
# ------------------------------------------------------------------------------
#
# files(): T·∫°o danh s√°ch c√°c file source
# Th·ª© t·ª± kh√¥ng quan tr·ªçng - Vala compiler t·ª± x·ª≠ l√Ω dependencies
#
# C√°c file trong d·ª± √°n:
#   - main.vala:             Entry point, kh·ªüi t·∫°o Application
#   - window.vala:           Giao di·ªán ch√≠nh, x·ª≠ l√Ω tabs, web views
#   - history_manager.vala:  Qu·∫£n l√Ω l·ªãch s·ª≠ duy·ªát web (l∆∞u/ƒë·ªçc JSON)
#   - history_dialog.vala:   Dialog hi·ªÉn th·ªã l·ªãch s·ª≠
#   - credential_manager.vala: Qu·∫£n l√Ω m·∫≠t kh·∫©u (GNOME Keyring)
#
sources = files(
  'main.vala',
  'window.vala',
  'history_manager.vala',
  'history_dialog.vala',
  'credential_manager.vala',
)

# ------------------------------------------------------------------------------
# T·∫†O EXECUTABLE V·ªöI SECURITY HARDENING FLAGS
# ------------------------------------------------------------------------------
#
# executable(): ƒê·ªãnh nghƒ©a c√°ch build m·ªôt executable
#
# Tham s·ªë:
#   - 'my-browser': T√™n file executable output
#   - sources: Danh s√°ch source files
#   - dependencies: Th∆∞ vi·ªán c·∫ßn link (t·ª´ root meson.build)
#   - install: true = install v√†o system khi ch·∫°y 'ninja install'
#   - c_args: Compiler flags cho C code
#   - link_args: Linker flags
#
# SECURITY FLAGS:
#   -fstack-protector-strong: Stack canary protection
#   -D_FORTIFY_SOURCE=2: Buffer overflow detection
#   -Wformat -Werror=format-security: Format string protection
#   -Wl,-z,relro: Relocation Read-Only
#   -Wl,-z,now: Full RELRO (immediate binding)
#   -pie: Position Independent Executable
#
# K·∫øt qu·∫£: build/app/my-browser (hardened binary)
#
executable('my-browser',
  sources,
  dependencies: deps,
  install: true,
  c_args: [
    '-fstack-protector-strong',  # Stack canaries against buffer overflows
    '-D_FORTIFY_SOURCE=2',       # Runtime buffer overflow checks
    '-Wformat',                   # Check printf/scanf format strings
    '-Werror=format-security',    # Treat format security warnings as errors
  ],
  link_args: [
    '-Wl,-z,relro',              # Mark relocation sections read-only
    '-Wl,-z,now',                # Resolve all symbols at program startup (full RELRO)
    '-pie',                       # Position independent executable for ASLR
  ],
)

# ------------------------------------------------------------------------------
# INSTALL DATA FILES
# ------------------------------------------------------------------------------
#
# install_data(): Copy file v√†o ƒë∆∞·ªùng d·∫´n install
#
# Tham s·ªë:
#   - 'autofill.js': File c·∫ßn install
#   - install_dir: Th∆∞ m·ª•c ƒë√≠ch
#
# get_option('datadir'): L·∫•y ƒë∆∞·ªùng d·∫´n data directory
#   - M·∫∑c ƒë·ªãnh: /usr/local/share
#   - C√≥ th·ªÉ thay ƒë·ªïi: meson setup build -Dprefix=/usr
#
# K·∫øt qu·∫£: /usr/local/share/my-browser/autofill.js
#
# T·∫°i sao c·∫ßn install autofill.js?
#   - Khi ch·∫°y t·ª´ build directory: ƒê·ªçc t·ª´ app/autofill.js
#   - Khi install v√†o system: ƒê·ªçc t·ª´ /usr/local/share/my-browser/autofill.js
#   - window.vala ki·ªÉm tra c·∫£ 2 ƒë∆∞·ªùng d·∫´n
#
install_data('autofill.js', install_dir: get_option('datadir') / 'my-browser')

# ==============================================================================
# üìù C√ÅCH S·ª¨ D·ª§NG
# ==============================================================================
#
# 1. PH√ÅT TRI·ªÇN (Development):
#    cd /path/to/my_browser
#    meson setup build
#    ninja -C build
#    ./build/app/my-browser
#
# 2. C√ÄI ƒê·∫∂T V√ÄO H·ªÜ TH·ªêNG:
#    ninja -C build install
#    my-browser
#
# 3. G·ª† C√ÄI ƒê·∫∂T:
#    ninja -C build uninstall
#
# 4. X√ìA BUILD V√Ä BUILD L·∫†I:
#    rm -rf build
#    meson setup build
#    ninja -C build
#
# ==============================================================================
